#!/usr/bin/python
# -*- coding: utf8 -*-
#Golden information compare

__author__ = 'Tan Ying<ying.tan@tcl.com>' 

import os
import sys
import getopt
import commands
from xml.etree import ElementTree
from utils import *

logger = log.getLogging('fai')

def pull_by_apk(cfile):

    if is_pull_aready('golden_collection.flag'):
        os.system('adb pull /sdcard/golden_collection.txt ./%s' % cfile)
        os.system('adb uninstall com.tcl.goldencollector')
        os.system('adb shell rm -f /data/local/tmp/goldencollector.apk')
        os.system('adb shell rm -f /sdcard/golden_collection.flag')
        os.system('adb shell rm -f /sdcard/golden_collection.txt')
    else:
        pull_by_apk(cfile)

def pull_info_from_phone(is_golden):
    global PULL_SUCCESS_FLAG

    if is_golden:
        property_file = GOLDEN_PROPERTY
        collection_file = GOLDEN_COLLECTION
        unconnected_hint = 'Please connect the Golden Phone with PC by USB.'
        success_hint = 'Pull properties from golden phone successful.\n'
    else:
        property_file = SAMPLE_PROPERTY
        collection_file = SAMPLE_COLLECTION
        unconnected_hint = 'Please connect the Sample Phone with PC by USB for comparation.'
        success_hint = 'Pull properties from sample phone successful.\n'

    command = 'adb shell getprop > %s' % property_file
    status, output = commands.getstatusoutput(command)

    if status == 0:
        os.system('adb install utils/goldencollector.apk')
        os.system('adb shell am start -n com.tcl.goldencollector/.MainActivity')

        pull_by_apk(collection_file)

        PULL_SUCCESS_FLAG = True
        print success_hint
    else:
        print unconnected_hint
        #restart server
        os.system('sudo adb kill-server')
        os.system('sudo adb start-server')

        usb_connected = raw_input('enter(aleady), else(exit)')

        if usb_connected == '':
            pull_info_from_phone(is_golden)
        else:
            print 'You pressed any key to exit, bye!'
            sys.exit(1)

def parse_collection_txt(file):
    fdict = {}

    sdict = {}
    rdict = {}

    f = open(file, 'r')
    flist = f.readlines()
    f.close()

    key = ''
    count = 0
    for item in flist:
        mod = count % 2
        if mod == 0:
            if item[:len(SETTINGS_KEY_TAG)] == SETTINGS_KEY_TAG:
                key = filter_xml_tag(SETTINGS_KEY_TAG, item)
            elif item[:len(RINGTONE_KEY_TAG)] == RINGTONE_KEY_TAG:
                key = filter_xml_tag(RINGTONE_KEY_TAG, item)
        else:
            if item[:len(SETTINGS_VAL_TAG)] == SETTINGS_VAL_TAG:
                val = filter_xml_tag(SETTINGS_VAL_TAG, item)
                sdict[key] = val
            elif item[:len(RINGTONE_VAL_TAG)] == RINGTONE_VAL_TAG:
                val = filter_xml_tag(RINGTONE_VAL_TAG, item)
                rdict[key] = val

        count += 1

    fdict['settings'] = sdict
    fdict['ringtone'] = rdict
    return fdict

def main():

    global PULL_SUCCESS_FLAG
    pull_info_from_phone(True)

    if PULL_SUCCESS_FLAG:
        PULL_SUCCESS_FLAG = False
        print('Please connect the Sample Phone with PC by USB for comparation:')
        usb_connected = raw_input('enter(aleady), else(exit)')
        if usb_connected == '':
            pull_info_from_phone(False)
        else:
            sys.exit(1)

        if PULL_SUCCESS_FLAG:
            diff_dict = {}
            #system property comparation
            sysprop_golden_dict = change_file_to_dict(GOLDEN_PROPERTY)
            sysprop_sample_dict = change_file_to_dict(SAMPLE_PROPERTY)
            sysprop_diff_dict = run_comparation(sysprop_golden_dict, sysprop_sample_dict)
            #setting comparation
            collection_golden_dict = parse_collection_txt(GOLDEN_COLLECTION)
            collection_sample_dict = parse_collection_txt(SAMPLE_COLLECTION)

            settings_golden_dict = collection_golden_dict['settings']
            settings_sample_dict = collection_sample_dict['settings']
            settings_diff_dict = run_comparation(settings_golden_dict, settings_sample_dict)

            #ringtone comparation
            ringtone_golden_dict = collection_golden_dict['ringtone']
            ringtone_sample_dict = collection_sample_dict['ringtone']
            ringtone_diff_dict = run_comparation(ringtone_golden_dict, ringtone_sample_dict)

            #contacts comapration(TODO Later)

            diff_dict['sysprop'] = sysprop_diff_dict
            diff_dict['settings'] = settings_diff_dict
            diff_dict['ringtone'] = ringtone_diff_dict
            output_diff_to_file(diff_dict, PROPERTY_COMPARE_RESULT)


if __name__ == '__main__':
    main()